# GHCR Docker build and push workflow
# Publishes images to GitHub Container Registry for AgentBeats deployment
#
# Usage:
#   - Automatic: Push to main or create a version tag (v*)
#   - Manual: Use workflow_dispatch

name: Build and Publish Docker Image

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Login to GHCR
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Set up QEMU for multi-platform builds
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Set up Docker Buildx for multi-platform builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build tags
      - name: Build tag list
        id: tags
        run: |
          TAGS=""
          SHA_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          # Docker tags must be lowercase
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="vacation-rentals-agent"

          # SHA tag (always)
          TAGS="ghcr.io/${OWNER}/${IMAGE_NAME}:${SHA_SHORT}"

          # Latest tag (on main branch)
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            TAGS="${TAGS},ghcr.io/${OWNER}/${IMAGE_NAME}:latest"
          fi

          # Version tag (on version tags)
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            TAGS="${TAGS},ghcr.io/${OWNER}/${IMAGE_NAME}:${VERSION}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "Generated tags: ${TAGS}"

      # Build and push
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: vacation_rentals_agent/docker_setup/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=vacation-rentals-agent
            org.opencontainers.image.description=A vacation rental customer service agent for policy questions and guidance
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      # Summary
      - name: Build summary
        run: |
          echo "## vacation-rentals-agent Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.tags.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
